# --- مرحله ۱: نصب و اجرای اولیه اولاما ---
import os
import time

print("⏳ در حال نصب اولاما در محیط کولب...")
# دانلود و اجرای اسکریپت نصب رسمی اولاما
!curl -fsSL https://ollama.com/install.sh | sh
print("✅ اولاما با موفقیت نصب شد.")

# اجرای سرور اولاما در پس‌زمینه تا بتوانیم با آن کار کنیم
# علامت & در انتهای دستور برای اجرای آن در پس‌زمینه است
!ollama serve &

# کمی صبر می‌کنیم تا سرور اولاما به طور کامل اجرا شود
print("⏳ منتظر بمانید تا سرور اولاما آماده شود...")
time.sleep(10)
print("✅ سرور اولاما آماده است.")


# --- مرحله ۲: دانلود (Pull) تمام مدل‌های مورد نیاز ---
# لیستی از مدل‌هایی که می‌خواهید در پکیج آفلاین شما باشند
models_to_pull = [
    "qwen2:7b",
    "mistral",
    "codestral",
    "gemma:7b",
    "command-r",
    "deepseek-coder:6.7b"
]

print("\n" + "="*50)
print("⏳ شروع دانلود مدل‌ها با اولاما...")
print("این فرآیند بسته به تعداد و حجم مدل‌ها ممکن است بسیار طولانی شود.")
print("="*50)

for model in models_to_pull:
    print(f"\n--- 📥 در حال دانلود مدل: {model} ---")
    !ollama pull {model}

print("\n✅ تمام مدل‌های درخواستی دانلود شدند.")


# --- مرحله ۳: آرشیو کردن اولاما و مدل‌های آن ---
# مسیرهای کلیدی که باید آرشیو شوند:
# ۱. فایل اجرایی اولاما
# ۲. پوشه حاوی مدل‌های دانلود شده
print("\n" + "="*50)
print("⏳ در حال ساخت پکیج آفلاین نهایی...")
print("="*50)

# اتصال به گوگل درایو برای ذخیره فایل نهایی
from google.colab import drive
drive.mount('/content/drive')

# تعریف نام و مسیر فایل خروجی در گوگل درایو
archive_path = "/content/drive/MyDrive/Ollama_Offline_Package.tar.gz"

# استفاده از دستور tar برای فشرده‌سازی فایل اجرایی اولاما و پوشه مدل‌ها
# این دو مسیر، مسیرهای استاندارد نصب اولاما در لینوکس هستند
!tar -czf {archive_path} /usr/local/bin/ollama /root/.ollama

print("\n" + "="*50)
print(f"🎉🎉🎉 پکیج آفلاین با موفقیت ساخته و در گوگل درایو شما ذخیره شد!")
print(f"مسیر فایل: {archive_path}")
print("="*50)
